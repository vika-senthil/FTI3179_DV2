<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Global Plane Crashes ‚úàÔ∏é (1908 ‚Äì 2023)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Vega runtime, Vega-Lite grammar to mount charts -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    :root { --fg:#111; --muted:#444; --bg:#e6f2ff; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; padding:24px; color:var(--fg); background:var(--bg); line-height:1.6; }
    header, .viz-wrap, .footer { max-width:1100px; margin:0 auto; }
    header { margin-bottom:16px; text-align:center; }
    h1 { margin:0 0 8px 0; font-size:48px; font-weight:800; letter-spacing:1px; text-transform:uppercase; color:#0a2740; text-shadow:1px 2px 6px rgba(0,0,0,0.15); }
    h2 { margin:0 0 8px 0; font-size:22px; }
    p { margin:8px 0; color:var(--muted); }
    .note{ font-size:14px; color:#556 }
    .callout{ margin-top:10px; padding:10px 12px; background:#f2f7ff; border:1px solid #cfe1ff; border-radius:10px; font-size:14px; color:#234; }
    .callout strong{ color:#0a2740 }
    .infographic-row { display:flex; justify-content:space-between; gap:16px; margin:28px 0 32px 0; }
    .flip-card { width:33%; height:220px; perspective:1000px; }
    .flip-inner { position:relative; width:100%; height:100%; transition:transform .8s; transform-style:preserve-3d; }
    .flip-card:hover .flip-inner { transform:rotateY(180deg); }
    .flip-front, .flip-back { position:absolute; inset:0; border-radius:14px; border:2px solid #ccc; box-shadow:0 2px 8px rgba(0,0,0,.05); display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; text-align:center; font-weight:600; -webkit-backface-visibility:hidden; backface-visibility:hidden; }
    .flip-front { background:#fff; color:#333; font-size:18px; }
    .flip-front span { font-size:36px; margin-bottom:10px; }
    .flip-front small { color:#777; font-size:13px; margin-top:8px; }
    .flip-back { background:#1f77b4; color:#fff; transform:rotateY(180deg); font-size:14px; line-height:1.4; }
    .panel { background:#fff; border-radius:14px; border:1px solid #eee; box-shadow:0 4px 18px rgba(0,0,0,.07); padding:16px; margin:16px auto; }
    .charts { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:16px; }
    .chart { min-width:0; width:100%; }
    @media (max-width:900px){ .charts { grid-template-columns:1fr; } .infographic-row { flex-direction:column; } .flip-card { width:100%; } }
    .error { color:#b00020; white-space:pre-wrap; margin-top:12px; display:none; }
    .meta { margin-top:6px; font-size:14px; color:#556; }
    .meta a { color:#0a2740; text-decoration:underline; }
  </style>
</head>
<body>
<header>
  <h1>Global Plane Crashes ‚úàÔ∏é (1908 ‚Äì 2023)</h1>
  <p>Visualising over a century of aviation incidents worldwide.</p>

  <!-- Flip-cards are decorative/contextual -->
  <div class="infographic-row">
    <div class="flip-card"><div class="flip-inner">
      <div class="flip-front"><span>‚úàÔ∏è</span>Tenerife Airport Disaster<small>(Hover)</small></div>
      <div class="flip-back"><div><strong>Year:</strong> 1977<br><strong>Operator:</strong> KLM & Pan Am<br><strong>Aboard:</strong> 644<br><strong>Deaths:</strong> 583</div></div>
    </div></div>
    <div class="flip-card"><div class="flip-inner">
      <div class="flip-front"><span>üõ´</span>JAL Flight 123<small>(Hover)</small></div>
      <div class="flip-back"><div><strong>Year:</strong> 1985<br><strong>Operator:</strong> Japan Airlines<br><strong>Aboard:</strong> 524<br><strong>Deaths:</strong> 520</div></div>
    </div></div>
    <div class="flip-card"><div class="flip-inner">
      <div class="flip-front"><span>üõ©Ô∏è</span>Charkhi Dadri<small>(Hover)</small></div>
      <div class="flip-back"><div><strong>Year:</strong> 1996<br><strong>Operator:</strong> SV & KZ<br><strong>Aboard/Deaths:</strong> 349</div></div>
    </div></div>
  </div>

  <div class="panel" style="text-align:left">
    <h2>How to Read this Dashboard</h2>
    <p class="note">Map with year slider ‚Üí trends (line) ‚Üí severity (scatter) ‚Üí seasonality (heatmap) ‚Üí operators (bar).
      This sequence is helpful to explain in the interview.</p>
  </div>

  <div class="panel" style="text-align:left">
    <h2>Key Insights at a Glance</h2>
    <div class="callout">
      <ul style="margin:0 0 0 18px;padding:0">
        <li><strong>Concentration:</strong> clusters align with traffic corridors.</li>
        <li><strong>Safety improvements:</strong> totals drop post-1980s.</li>
        <li><strong>Severity envelope:</strong> most crashes are below the ‚Äúall aboard‚Äù line.</li>
        <li><strong>Seasonality/operators:</strong> subtle monthly patterning; a few operators dominate counts.</li>
      </ul>
    </div>
  </div>
</header>

<!-- Mount points for Vega-Lite charts -->
<div class="viz-wrap panel">
  <h2>Crash Locations & Fatalities (Map)</h2>
  <p class="note">Interactive filter via a bound <code>param</code> (year slider). Size & colour ~ onboard fatalities.</p>
  <div id="crash_map" class="chart" aria-label="World map of crash locations"></div>
  <div id="map_err" class="error"></div>
</div>

<div class="viz-wrap panel">
  <h2>Fatalities & Crash Numbers Over Time ‚Ä¢ Aboard vs Fatalities</h2>
  <p class="note">Two-layer line chart uses independent y-scales; scatter uses a y=x reference line.</p>
  <div class="charts">
    <div id="line_chart" class="chart" aria-label="Yearly totals of fatalities and crashes"></div>
    <div id="scatter_chart" class="chart" aria-label="Crash severity scatter plot"></div>
  </div>
</div>

<div class="viz-wrap panel">
  <h2>Crash Frequency by Month √ó Decade ‚Ä¢ Top Operators</h2>
  <p class="note">Heatmap aggregates counts by month/decade; operator bars rank with a window <code>rank</code>.</p>
  <div class="charts">
    <div id="heatmap" class="chart" aria-label="Heatmap of crashes by month and decade"></div>
    <div>
      <div id="operator_hist" class="chart" aria-label="Top operators by crash count"></div>
      <div id="operator_err" class="error"></div>
    </div>
  </div>
</div>

<div class="footer" style="margin-top:24px;">
  <p>Data: <a href="DV2_NEW_DATA.csv">DV2_NEW_DATA.csv</a> | Built with Vega-Lite</p>
  <p class="meta">Author: <strong>Rithvika Senthil</strong> ¬∑ Last updated: <span id="lastUpdated"></span><br>Methods: Dates parsed; coordinates normalised; aggregates by year/decade; top-20 operators (rank window).</p>
</div>

<script>
// ===============================
// SPEC 1: MAP with year slider
// ===============================
function mapSpec(){
  return {
    $schema: "https://vega.github.io/schema/vega-lite/v5.json",
    description: "Map of crash locations filtered by selected year.",
    autosize: { type: "fit", contains: "padding" }, // responsive inside container
    width: "container", height: 560,
    projection: { type: "equalEarth" },

    // PARAM: creates a native <input type=range> bound to this value
    params: [{
      name: "yearSel", value: 1950,
      bind: { input: "range", min: 1908, max: 2023, step: 1, name: "Year: " }
    }],

    layer: [
      // Base world map layer (TopoJSON ‚Üí geoshape)
      {
        data: { url: "https://cdn.jsdelivr.net/npm/vega-datasets@2.0.0/data/world-110m.json",
                format: { type: "topojson", feature: "countries" } },
        mark: { type: "geoshape", fill: "#e6e6e6", stroke: "white" }
      },
      // Crash points layer
      {
        data: { url: "DV2_NEW_DATA.csv", format: { type: "csv", parse: { Latitude: "number", Longitude: "number" } } },
        transform: [
          // Robust date parsing from multiple formats
          { calculate: "datum.Date || ''", as: "_dateRaw" },
          { calculate: "timeParse(datum._dateRaw, '%m/%d/%Y') || timeParse(datum._dateRaw, '%Y-%m-%d') || timeParse(datum._dateRaw, '%d/%m/%Y')", as: "_date" },
          { filter: "isDate(datum._date)" },
          { calculate: "year(datum._date)", as: "Year" },

          // Compute Aboard total: prefer total; else passengers+crew
          { calculate: "toNumber(replace(datum['Aboard'] || '', /[^0-9.\-]/g, ''))", as: "_aboardA" },
          { calculate: "toNumber(replace(datum['Aboard Pa'] || '', /[^0-9.\-]/g, ''))", as: "_aboardP" },
          { calculate: "toNumber(replace(datum['Aboard Cr'] || '', /[^0-9.\-]/g, ''))", as: "_aboardC" },
          { calculate: "(isFinite(datum._aboardA) && datum._aboardA>0) ? datum._aboardA : ((isFinite(datum._aboardP)?datum._aboardP:0) + (isFinite(datum._aboardC)?datum._aboardC:0))", as: "AboardNum" },

          // Compute onboard fatalities (excluding ground), with same fallback
          { calculate: "toNumber(replace(datum['Fatalities'] || '', /[^0-9.\-]/g, ''))", as: "_fatT" },
          { calculate: "toNumber(replace(datum['Fatalities Pa'] || '', /[^0-9.\-]/g, ''))", as: "_fatP" },
          { calculate: "toNumber(replace(datum['Fatalities Cr'] || '', /[^0-9.\-]/g, ''))", as: "_fatC" },
          { calculate: "(isFinite(datum._fatT) && datum._fatT>0) ? datum._fatT : ((isFinite(datum._fatP)?datum._fatP:0) + (isFinite(datum._fatC)?datum._fatC:0))", as: "FatalitiesNum" },

          // Interactivity + data hygiene
          { filter: "datum.Year == yearSel" },
          { filter: "isFinite(datum.Latitude) && isFinite(datum.Longitude)" }
        ],
        mark: { type: "circle", opacity: 0.7 },
        encoding: {
          longitude: { field: "Longitude", type: "quantitative" },
          latitude:  { field: "Latitude",  type: "quantitative" },
          size:  { field: "FatalitiesNum", type: "quantitative", scale: { range: [12, 900] } },
          color: { field: "FatalitiesNum", type: "quantitative", scale: { scheme: "reds" } },
          tooltip: [
            { field: "_date", title: "Date" }, { field: "Time" }, { field: "Location" },
            { field: "Operator" }, { field: "AboardNum", title: "Aboard" },
            { field: "FatalitiesNum", title: "Fatalities (onboard)" }, { field: "Ground", title: "Ground Fatalities" }
          ]
        }
      }
    ]
  };
}

// ==============================================
// SPEC 2: YEARLY TOTALS (dual‚Äëaxis layered lines)
// ==============================================
const specLine = {
  $schema: "https://vega.github.io/schema/vega-lite/v5.json",
  description: "Yearly totals: fatalities (sum) vs crashes (count).",
  width: "container", height: 320,
  data: { url: "DV2_NEW_DATA.csv", format: { type: "csv" } },
  transform: [
    { calculate: "datum.Date || ''", as: "_dateRaw" },
    { calculate: "timeParse(datum._dateRaw, '%m/%d/%Y') || timeParse(datum._dateRaw, '%Y-%m-%d') || timeParse(datum._dateRaw, '%d/%m/%Y')", as: "_date" },
    { filter: "isDate(datum._date)" },
    { calculate: "year(datum._date)", as: "Year" },
    // Create onboard fatalities per row, then aggregate once per Year
    { calculate: "toNumber(replace(datum['Fatalities'] || '', /[^0-9.\-]/g, ''))", as: "_fatT" },
    { calculate: "toNumber(replace(datum['Fatalities Pa'] || '', /[^0-9.\-]/g, ''))", as: "_fatP" },
    { calculate: "toNumber(replace(datum['Fatalities Cr'] || '', /[^0-9.\-]/g, ''))", as: "_fatC" },
    { calculate: "(isFinite(datum._fatT) && datum._fatT>0) ? datum._fatT : ((isFinite(datum._fatP)?datum._fatP:0) + (isFinite(datum._fatC)?datum._fatC:0))", as: "FatalitiesNum" },
    { aggregate: [ { op: "sum", field: "FatalitiesNum", as: "Fatalities" }, { op: "count", as: "Crashes" } ], groupby: ["Year"] }
  ],
  resolve: { scale: { y: "independent" } }, // use dual y-axes
  layer: [
    { mark: { type: "line", point: true, strokeWidth: 2, color: "#d62728" },
      encoding: { x: { field: "Year", type: "quantitative" }, y: { field: "Fatalities", type: "quantitative", axis: { title: "Fatalities (sum/year)" } }, tooltip: [ { field: "Year" }, { field: "Fatalities" }, { field: "Crashes" } ] } },
    { mark: { type: "line", point: true, strokeWidth: 2, color: "#1f77b4" },
      encoding: { x: { field: "Year", type: "quantitative" }, y: { field: "Crashes", type: "quantitative", axis: { title: "Crashes (count/year)", orient: "right" } } } }
  ]
};

// ======================================
// SPEC 3: SCATTER (severity with y=x ref)
// ======================================
const specScatter = {
  $schema: "https://vega.github.io/schema/vega-lite/v5.json",
  description: "Crash-level severity: Aboard vs Fatalities with y=x line.",
  width: "container", height: 320,
  data: { url: "DV2_NEW_DATA.csv", format: { type: "csv" } },
  transform: [
    { calculate: "datum.Date || ''", as: "_dateRaw" },
    { calculate: "timeParse(datum._dateRaw, '%m/%d/%Y') || timeParse(datum._dateRaw, '%Y-%m-%d') || timeParse(datum._dateRaw, '%d/%m/%Y')", as: "_date" },
    // Compute Aboard & Fatalities per row (fallback totals)
    { calculate: "toNumber(replace(datum['Aboard'] || '', /[^0-9.\-]/g, ''))", as: "_aboardA" },
    { calculate: "toNumber(replace(datum['Aboard Pa'] || '', /[^0-9.\-]/g, ''))", as: "_aboardP" },
    { calculate: "toNumber(replace(datum['Aboard Cr'] || '', /[^0-9.\-]/g, ''))", as: "_aboardC" },
    { calculate: "(isFinite(datum._aboardA) && datum._aboardA>0) ? datum._aboardA : ((isFinite(datum._aboardP)?datum._aboardP:0) + (isFinite(datum._aboardC)?datum._aboardC:0))", as: "AboardNum" },
    { calculate: "toNumber(replace(datum['Fatalities'] || '', /[^0-9.\-]/g, ''))", as: "_fatT" },
    { calculate: "toNumber(replace(datum['Fatalities Pa'] || '', /[^0-9.\-]/g, ''))", as: "_fatP" },
    { calculate: "toNumber(replace(datum['Fatalities Cr'] || '', /[^0-9.\-]/g, ''))", as: "_fatC" },
    { calculate: "(isFinite(datum._fatT) && datum._fatT>0) ? datum._fatT : ((isFinite(datum._fatP)?datum._fatP:0) + (isFinite(datum._fatC)?datum._fatC:0))", as: "FatalitiesNum" },
    { filter: "isFinite(datum.AboardNum) && isFinite(datum.FatalitiesNum)" }
  ],
  layer: [
    // y=x reference diagonal
    { mark: { type: "line", strokeDash: [4,4], opacity: 0.7 },
      data: { values: [ { x: 0, y: 0 }, { x: 650, y: 650 } ] },
      encoding: { x: { field: "x", type: "quantitative", title: "Aboard", scale: { domain: [0, 650] } }, y: { field: "y", type: "quantitative", title: "Fatalities (onboard)", scale: { domain: [0, 650] } } } },
    // Points layer
    { mark: { type: "point", filled: true, opacity: 0.6, color: "#1f77b4" },
      encoding: { x: { field: "AboardNum", type: "quantitative", scale: { domain: [0, 650] } }, y: { field: "FatalitiesNum", type: "quantitative", scale: { domain: [0, 650] } }, tooltip: [ { field: "_date", title: "Date" }, { field: "Time" }, { field: "Operator" }, { field: "AboardNum", title: "Aboard" }, { field: "FatalitiesNum", title: "Fatalities (onboard)" }, { field: "Ground", title: "Ground Fatalities" } ] } }
  ]
};

// ==================================
// SPEC 4: HEATMAP (Month √ó Decade)
// ==================================
const specHeatmap = {
  $schema: "https://vega.github.io/schema/vega-lite/v5.json",
  description: "Crash frequency by month and decade.",
  width: "container", height: 420,
  data: { url: "DV2_NEW_DATA.csv", format: { type: "csv" } },
  transform: [
    { calculate: "datum.Date || ''", as: "_dateRaw" },
    { calculate: "timeParse(datum._dateRaw, '%m/%d/%Y') || timeParse(datum._dateRaw, '%Y-%m-%d') || timeParse(datum._dateRaw, '%d/%m/%Y')", as: "_date" },
    { filter: "isDate(datum._date)" },
    { calculate: "year(datum._date)", as: "Year" },
    { calculate: "month(datum._date)", as: "MonthIndex" }, // 0..11
    { calculate: "floor(datum.Year/10)*10", as: "Decade" }, // e.g., 1980, 1990
    { aggregate: [ { op: "count", as: "Crashes" } ], groupby: ["Decade","MonthIndex"] },
    { calculate: "toString(datum.Decade)+'s'", as: "DecadeLabel" },
    { calculate: "['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][datum.MonthIndex]", as: "MonthName" }
  ],
  mark: { type: "rect" },
  encoding: {
    x: { field: "MonthName", type: "ordinal", sort: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"] },
    y: { field: "DecadeLabel", type: "ordinal", sort: { field: "Decade", order: "ascending" } },
    color: { field: "Crashes", type: "quantitative", scale: { scheme: "reds" } },
    tooltip: [ { field: "DecadeLabel" }, { field: "MonthName" }, { field: "Crashes" } ]
  }
};

// =========================================
// SPEC 5: TOP OPERATORS (ranked bar chart)
// =========================================
const specOperator = {
  $schema: "https://vega.github.io/schema/vega-lite/v5.json",
  description: "Top operators by recorded crashes (count).",
  width: "container", height: 420,
  data: { url: "DV2_NEW_DATA.csv", format: { type: "csv" } },
  transform: [
    { filter: "isValid(datum.Operator)" }, // remove blank labels
    { aggregate: [ { op: "count", as: "Crashes" } ], groupby: ["Operator"] },
    { window: [ { op: "rank", as: "rank" } ], sort: [ { field: "Crashes", order: "descending" } ] },
    { filter: "datum.rank <= 20" } // keep top 20
  ],
  mark: { type: "bar" },
  encoding: {
    y: { field: "Operator", type: "ordinal", sort: "-x", axis: { labelLimit: 200 } },
    x: { field: "Crashes", type: "quantitative" },
    color: { value: "#1f77b4" },
    tooltip: [ { field: "Operator" }, { field: "Crashes" } ]
  }
};

// ==========================
// EMBED all five visuals
// ==========================
vegaEmbed('#crash_map', mapSpec())
  .catch(err => { const el = document.getElementById('map_err'); el.style.display='block'; el.textContent=String(err); });
vegaEmbed('#line_chart',    specLine);
vegaEmbed('#scatter_chart', specScatter);
vegaEmbed('#heatmap',       specHeatmap);
vegaEmbed('#operator_hist', specOperator)
  .catch(err => { const el = document.getElementById('operator_err'); el.style.display='block'; el.textContent=String(err); });

// Footer timestamp helper
(function(){
  const el = document.getElementById('lastUpdated');
  if(el){ el.textContent = new Date().toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
})();
</script>
</body>
</html>
